<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generatore M3U8</title>
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        .container {
            text-align: center;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        #status {
            margin-top: 20px;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Generatore Lista M3U8</h1>
        <button id="generate-btn">Genera M3U8</button>
        <div id="status">Premi il pulsante per generare il file M3U8</div>
    </div>

    <py-script>
        import js
        import re
        from pyodide.http import pyfetch
        from pyodide.ffi import create_proxy

        async def fetch_page(url):
            try:
                response = await pyfetch(url)
                if response.status == 200:
                    return await response.text()
                else:
                    return None
            except Exception as e:
                js.document.getElementById("status").innerText = f"Errore nel caricamento della pagina: {str(e)}"
                return None

        def format_channel_name(raw_name):
            # Estrai il nome del canale da (skycinemaaction) o simile
            match = re.search(r'channel\((.*?)\)', raw_name)
            if not match:
                return "Unknown Channel"
            channel = match.group(1)
            # Converti skycinemaaction in Sky Cinema Action
            words = channel.replace('sky', 'Sky').split()
            formatted = ' '.join(word.capitalize() for word in words)
            return formatted

        async def generate_m3u8(event):
            js.document.getElementById("status").innerText = "Caricamento in corso..."
            
            # URL modificabile
            url = "https://xrom-ital-tg.work/dallas/lakers/xrom/js-player-list/epg-list-m3u/epg-sky-xrita"
            
            # Carica la pagina
            html_content = await fetch_page(url)
            if not html_content:
                js.document.getElementById("status").innerText = "Errore: Impossibile caricare la pagina"
                return

            # Crea un elemento DOM temporaneo per parsare l'HTML
            parser = js.DOMParser.new()
            doc = parser.parseFromString(html_content, "text/html")
            
            # Trova tutti gli elementi con classe channel-item
            channel_items = doc.querySelectorAll(".channel-item")
            m3u8_content = "#EXTM3U\n"
            
            for item in channel_items:
                try:
                    a_tag = item.querySelector("a")
                    href = a_tag.getAttribute("href")
                    if "url=" in href:
                        url_part = href.split("url=")[1]
                        # Estrai il nome del canale dall'URL
                        channel_name = format_channel_name(url_part)
                        # Aggiungi al contenuto M3U8
                        m3u8_content += f'#EXTINF:-1,{channel_name}\n{url_part}\n'
                except Exception as e:
                    js.document.getElementById("status").innerText = f"Errore durante l'estrazione: {str(e)}"
            
            # Crea il file M3U8 e avvia il download
            if m3u8_content != "#EXTM3U\n":
                blob = js.Blob.new([m3u8_content], type="application/m3u8")
                url = js.URL.createObjectURL(blob)
                link = js.document.createElement("a")
                link.href = url
                link.download = "channels.m3u8"
                link.click()
                js.URL.revokeObjectURL(url)
                js.document.getElementById("status").innerText = "File M3U8 generato e scaricato!"
            else:
                js.document.getElementById("status").innerText = "Nessun canale trovato"

        # Collega il pulsante alla funzione
        button = js.document.getElementById("generate-btn")
        button.addEventListener("click", create_proxy(generate_m3u8))
    </py-script>
</body>
</html>
